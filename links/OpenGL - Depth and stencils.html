<!DOCTYPE html>
<!-- saved from url=(0029)https://open.gl/depthstencils -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		

		<title>OpenGL - Depth and stencils</title>

		<meta name="description" content="An extensive, yet beginner friendly guide to using modern OpenGL for game development on all major platforms.">
		<meta name="author" content="Alexander Overvoorde">
		<meta name="keywords" content="opengl, opengl 3.2, deprecated, non-deprecated, tutorial, guide, cross-platform, game, games, graphics, sfml, sdl, glfw, glut, openglut, beginner, easy">

		<link rel="shortcut icon" type="image/png" href="https://open.gl/media/tag.png">
		<link rel="stylesheet" type="text/css" href="./OpenGL - Depth and stencils_files/stylesheet.css">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
		<link rel="stylesheet" type="text/css" href="./OpenGL - Depth and stencils_files/mobile.css" media="screen and (max-width: 1024px)">

		<script type="text/javascript" async="" src="./OpenGL - Depth and stencils_files/ga.js.download"></script><script type="text/x-mathjax-config;executed=true">
			// MathJax
			MathJax.Hub.Config( {
			  tex2jax: { inlineMath: [ [ '$', '$' ], [ '\\(', '\\)' ] ] },
			  menuSettings: { context: "Browser" }
			} );
		</script>
		<script type="text/javascript" src="./OpenGL - Depth and stencils_files/MathJax.js.download"></script>

		<link rel="stylesheet" href="./OpenGL - Depth and stencils_files/zenburn.min.css">
		<script type="text/javascript" src="./OpenGL - Depth and stencils_files/highlight.min.js.download"></script>
		<script type="text/javascript" src="./OpenGL - Depth and stencils_files/glmatrix.js.download"></script>
		<script type="text/javascript">
			// Syntax highlighting
			hljs.initHighlightingOnLoad();

			// Disqus
			var disqus_url = "http://open.gl/?content=depthstencils";
			var disqus_identifier = "depthstencils";

			// Google Analytics
			var _gaq = _gaq || [];
			_gaq.push(["_setAccount", "UA-25119105-1"]);
			_gaq.push(["_setDomainName", "open.gl"]);
			_gaq.push(["_setAllowHash", "false"]);
			_gaq.push(["_trackPageview"]);

			(function()
			{
				var ga = document.createElement("script");
				ga.type = "text/javascript";
				ga.async = true;
				ga.src = ("https:" == document.location.protocol ? "https://ssl" : "http://www") + ".google-analytics.com/ga.js";
				var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(ga, s);
			})();

			// WebGL demos
			var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
			var callbacks = [];
			var frame = function() {
				var time = +new Date() / 1000;

				for (var i = 0; i < callbacks.length; i++) {
					var rect = callbacks[i].canvas.getBoundingClientRect();

					if (rect.bottom > 0 && rect.top < window.innerHeight)
						callbacks[i].callback( time );
				}

				requestAnimationFrame(frame);
			}
			function registerAnimatedCanvas(canvas, callback) {
				callbacks.push({canvas: canvas, callback: callback});
			}
			requestAnimationFrame(frame);
		</script>
		<!--[if lt IE 9]>
		<script src="media/html5shiv.js"></script>
		<![endif]-->
	<style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><script type="text/javascript" async="" src="./OpenGL - Depth and stencils_files/embed.js.download"></script><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style></head>

	<body><div id="MathJax_Message" style="display: none;"></div>
		<div id="page">
			<!-- Work in progress ribbon -->
			<a href="https://github.com/Overv/Open.GL"><img id="ribbon" src="./OpenGL - Depth and stencils_files/ribbon_fork.png" alt="Fork me!"></a>

			<!-- Navigation items -->
			<input type="checkbox" id="nav_toggle">
			<nav>
				<label for="nav_toggle" data-open="≡" data-close="✕"></label>
				<ul>
					<li><a href="https://open.gl/introduction">Introduction</a></li>
<li><a href="https://open.gl/context">Context creation</a></li>
<li><a href="https://open.gl/drawing">Drawing polygons</a></li>
<li><a href="https://open.gl/textures">Textures</a></li>
<li><a href="https://open.gl/transformations">Transformations</a></li>
<li class="selected">Depth and stencils</li>
<li><a href="https://open.gl/framebuffers">Framebuffers</a></li>
<li><a href="https://open.gl/geometry">Geometry shaders</a></li>
<li><a href="https://open.gl/feedback">Transform Feedback</a></li>
				</ul>

				<blockquote style="padding-bottom: 8px; font-size: 14px">
					<h2 style="margin: 0">Links</h2>

                    <a href="https://github.com/Polytonic/Glitter" style="text-decoration: underline">OpenGL boilerplate code</a><br>

                    <a href="https://github.com/zuck/opengl-examples" style="text-decoration: underline">Easy-to-build code</a><br>
                    <a href="https://www.youtube.com/playlist?list=PLW3Zl3wyJwWNQjMz941uyOIq3Nw6bcDYC" style="text-decoration: underline">Matrix math tutorials</a><br>
                    <a href="http://docs.gl/" style="text-decoration: underline">OpenGL reference</a>
				</blockquote>

                <div id="adbox">
                    <script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                    <!-- Open.GL Responsive -->
                    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4259747131061893" data-ad-slot="6609097747" data-ad-format="auto"></ins>
                    <script>
                        (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
			</nav>

			<!-- Content container -->
			<main>
				<article>
					<h1 id="Extrabuffers">Extra buffers</h1>

<p>Up until now there is only one type of output buffer you've made use of, the color buffer. This chapter will discuss two additional types, the <em>depth buffer</em> and the <em>stencil buffer</em>. For each of these a problem will be presented and subsequently solved with that specific buffer.</p>

<h1 id="Preparations">Preparations</h1>

<p>To best demonstrate the use of these buffers, let's draw a cube instead of a flat shape. The vertex shader needs to be modified to accept a third coordinate:</p>

<pre><code class="cpp">in vec3 position;
...
gl_Position = proj * view * model * vec4(position, <span class="number">1.0</span>);
</code></pre>

<p>We're also going to need to alter the color again later in this chapter, so make sure the fragment shader multiplies the texture color by the color attribute:</p>

<pre><code class="cpp">vec4 texColor = mix(texture(texKitten, Texcoord),
                     texture(texPuppy, Texcoord), <span class="number">0.5</span>);
outColor = vec4(Color, <span class="number">1.0</span>) * texColor;
</code></pre>

<p>Vertices are now 8 floats in size, so you'll have to update the vertex attribute offsets and strides as well. Finally, add the extra coordinate to the vertex array:</p>

<pre><code class="cpp"><span class="keyword">float</span> vertices[] = {
  <span class="comment">// X      Y     Z     R     G     B     U     V</span>
    -<span class="number">0.5</span>f,  <span class="number">0.5</span>f, <span class="number">0.0</span>f, <span class="number">1.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f,
     <span class="number">0.5</span>f,  <span class="number">0.5</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">1.0</span>f, <span class="number">0.0</span>f, <span class="number">1.0</span>f, <span class="number">0.0</span>f,
     <span class="number">0.5</span>f, -<span class="number">0.5</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">1.0</span>f, <span class="number">1.0</span>f, <span class="number">1.0</span>f,
    -<span class="number">0.5</span>f, -<span class="number">0.5</span>f, <span class="number">0.0</span>f, <span class="number">1.0</span>f, <span class="number">1.0</span>f, <span class="number">1.0</span>f, <span class="number">0.0</span>f, <span class="number">1.0</span>f
};
</code></pre>

<p>Confirm that you've made all the required changes by running your program and checking if it still draws a flat spinning image of a kitten blended with a puppy. A single cube consists of 36 vertices (6 sides * 2 triangles * 3 vertices), so I will ease your life by providing the array <a href="https://open.gl/content/code/c5_vertices.txt">here</a>.</p>

<pre><code class="cpp">glDrawArrays(GL_TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);
</code></pre>

<p>We will not make use of element buffers for drawing this cube, so you can use <a href="http://docs.gl/gl3/glDrawArrays"><code>glDrawArrays</code></a> to draw it. If you were confused by this explanation, you can compare your program to <a href="https://open.gl/content/code/c5_cube.txt">this reference code</a>.</p>

<div class="livedemo_wrap">
    <div class="livedemo" id="demo_c5_cube" style="background: url(&#39;/media/img/c5_window.png&#39;)">
        <canvas width="640" height="480"></canvas>
        <script type="text/javascript" src="./OpenGL - Depth and stencils_files/c5_cube.js.download"></script>
    </div>
</div>

<p>It immediately becomes clear that the cube is not rendered as expected when seeing the output. The sides of the cube are being drawn, but they overlap each other in strange ways! The problem here is that when OpenGL draws your cube triangle-by-triangle, it will simply write over pixels even though something else may have been drawn there before. In this case OpenGL will happily draw triangles in the back over triangles at the front.</p>

<p>Luckily OpenGL offers ways of telling it when to draw over a pixel and when not to. I'll go over the two most important ways of doing that, depth testing and stencilling, in this chapter.</p>

<h1 id="Depthbuffer">Depth buffer</h1>

<p><em>Z-buffering</em> is a way of keeping track of the depth of every pixel on the screen. The depth is proportional to the distance between the screen plane and a fragment that has been drawn. That means that the fragments on the sides of the cube further away from the viewer have a higher depth value, whereas fragments closer have a lower depth value.</p>

<p>If this depth is stored along with the color when a fragment is written, fragments drawn later can compare their depth to the existing depth to determine if the new fragment is closer to the viewer than the old fragment. If that is the case, it should be drawn over and otherwise it can simply be discarded. This is known as <em>depth testing</em>.</p>

<p>OpenGL offers a way to store these depth values in an extra buffer, called the <em>depth buffer</em>, and perform the required check for fragments automatically. The fragment shader will not run for fragments that are invisible, which can have a significant impact on performance. This functionality can be enabled by calling <a href="http://docs.gl/gl3/glEnable"><code>glEnable</code></a>.</p>

<pre><code class="cpp">glEnable(GL_DEPTH_TEST);
</code></pre>

<p>If you enable this functionality now and run your application, you'll notice that you get a black screen. That happens because the depth buffer is filled with 0 depth for each pixel by default. Since no fragments will ever be closer than that they are all discarded.</p>

<p>The depth buffer can be cleared along with the color buffer by extending the <a href="http://docs.gl/gl3/glClear"><code>glClear</code></a> call:</p>

<pre><code class="cpp">glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
</code></pre>

<p>The default clear value for the depth is <code>1.0f</code>, which is equal to the depth of your far clipping plane and thus the furthest depth that can be represented. All fragments will be closer than that, so they will no longer be discarded.</p>

<div class="livedemo_wrap">
    <div class="livedemo" id="demo_c5_depth" style="background: url(&#39;/media/img/c5_window2.png&#39;)">
        <canvas width="640" height="480"></canvas>
        <script type="text/javascript" src="./OpenGL - Depth and stencils_files/c5_depth.js.download"></script>
    </div>
</div>

<p>With the depth test capability enabled, the cube is now rendered correctly. Just like the color buffer, the depth buffer has a certain amount of bits of precision which can be specified by you. Less bits of precision reduce the extra memory use, but can introduce rendering errors in more complex scenes.</p>

<h1 id="Stencilbuffer">Stencil buffer</h1>

<p>The stencil buffer is an optional extension of the depth buffer that gives you more control over the question of which fragments should be drawn and which shouldn't. Like the depth buffer, a value is stored for every pixel, but this time you get to control when and how this value changes and when a fragment should be drawn depending on this value. Note that if the depth test fails, the stencil test no longer determines whether a fragment is drawn or not, but these fragments can still affect values in the stencil buffer!</p>

<p>To get a bit more acquainted with the stencil buffer before using it, let's start by analyzing a simple example.</p>

<p><img src="./OpenGL - Depth and stencils_files/c5_stencil.png" alt=""></p>

<p>In this case the stencil buffer was first cleared with zeroes and then a rectangle of ones was drawn to it. The drawing operation of the cube uses the values from the stencil buffer to only draw fragments with a stencil value of 1.</p>

<p>Now that you have an understanding of what the stencil buffer does, we'll look at the relevant OpenGL calls.</p>

<pre><code class="cpp">glEnable(GL_STENCIL_TEST);
</code></pre>

<p>Stencil testing is enabled with a call to <a href="http://docs.gl/gl3/glEnable"><code>glEnable</code></a>, just like depth testing. You don't have to add this call to your code just yet. I'll first go over the API details in the next two sections and then we'll make a cool demo.</p>

<h2>Setting values</h2>

<p>Regular drawing operations are used to determine which values in the stencil buffer are affected by any stencil operation. If you want to affect a rectangle of values like in the sample above, simply draw a 2D quad in that area. What happens to those values can be controlled by you using the <a href="http://docs.gl/gl3/glStencilFunc"><code>glStencilFunc</code></a>, <a href="http://docs.gl/gl3/glStencilOp"><code>glStencilOp</code></a> and <a href="http://docs.gl/gl3/glStencilMask"><code>glStencilMask</code></a> functions.</p>

<p>The <a href="http://docs.gl/gl3/glStencilFunc"><code>glStencilFunc</code></a> call is used to specify the conditions under which a fragment passes the stencil test. Its parameters are discussed below.</p>

<ul>
<li><code>func</code>: The test function, can be <code>GL_NEVER</code>, <code>GL_LESS</code>, <code>GL_LEQUAL</code>, <code>GL_GREATER</code>, <code>GL_GEQUAL</code>, <code>GL_EQUAL</code>, <code>GL_NOTEQUAL</code>, and <code>GL_ALWAYS</code>.</li>
<li><code>ref</code>: A value to compare the stencil value to using the test function.</li>
<li><code>mask</code>: A bitwise AND operation is performed on the stencil value and reference value with this mask value before comparing them.</li>
</ul>

<p>If you don't want stencils with a value lower than 2 to be affected, you would use:</p>

<pre><code class="cpp">glStencilFunc(GL_GEQUAL, <span class="number">2</span>, <span class="number">0xFF</span>);
</code></pre>

<p>The mask value is set to all ones (in case of an 8 bit stencil buffer), so it will not affect the test.</p>

<p>The <a href="http://docs.gl/gl3/glStencilOp"><code>glStencilOp</code></a> call specifies what should happen to stencil values depending on the outcome of the stencil and depth tests. The parameters are:</p>

<ul>
<li><code>sfail</code>: Action to take if the stencil test fails.</li>
<li><code>dpfail</code>: Action to take if the stencil test is successful, but the depth test failed.</li>
<li><code>dppass</code>: Action to take if both the stencil test and depth tests pass.</li>
</ul>

<p>Stencil values can be modified in the following ways:</p>

<ul>
<li><code>GL_KEEP</code>: The current value is kept.</li>
<li><code>GL_ZERO</code>: The stencil value is set to 0.</li>
<li><code>GL_REPLACE</code>: The stencil value is set to the reference value in the <a href="http://docs.gl/gl3/glStencilFunc"><code>glStencilFunc</code></a> call.</li>
<li><code>GL_INCR</code>: The stencil value is increased by 1 if it is lower than the maximum value.</li>
<li><code>GL_INCR_WRAP</code>: Same as <code>GL_INCR</code>, with the exception that the value is set to 0 if the maximum value is exceeded.</li>
<li><code>GL_DECR</code>: The stencil value is decreased by 1 if it is higher than 0.</li>
<li><code>GL_DECR_WRAP</code>: Same as <code>GL_DECR</code>, with the exception that the value is set to the maximum value if the current value is 0 (the stencil buffer stores unsigned integers).</li>
<li><code>GL_INVERT</code>: A bitwise invert is applied to the value.</li>
</ul>

<p>Finally, <a href="http://docs.gl/gl3/glStencilMask"><code>glStencilMask</code></a> can be used to control the bits that are written to the stencil buffer when an operation is run. The default value is all ones, which means that the outcome of any operation is unaffected.</p>

<p>If, like in the example, you want to set all stencil values in a rectangular area to 1, you would use the following calls:</p>

<pre><code class="cpp">glStencilFunc(GL_ALWAYS, <span class="number">1</span>, <span class="number">0xFF</span>);
glStencilOp(GL_KEEP, GL_KEEP, GL_REPLACE);
glStencilMask(<span class="number">0xFF</span>);
</code></pre>

<p>In this case the rectangle shouldn't actually be drawn to the color buffer, since it is only used to determine which stencil values should be affected.</p>

<pre><code class="cpp">glColorMask(GL_FALSE, GL_FALSE, GL_FALSE, GL_FALSE);
glDepthMask(GL_FALSE);
</code></pre>

<p>The <a href="http://docs.gl/gl3/glColorMask"><code>glColorMask</code></a> function allows you to specify which data is written to the color buffer during a drawing operation. In this case you would want to disable all color channels (red, green, blue, alpha). Writing to the depth buffer needs to be disabled separately as well with <a href="http://docs.gl/gl3/glDepthMask"><code>glDepthMask</code></a>, so that cube drawing operation won't be affected by leftover depth values of the rectangle. This is cleaner than simply clearing the depth buffer again later.</p>

<h2>Using values in drawing operations</h2>

<p>With the knowledge about setting values, using them for testing fragments in drawing operations becomes very simple. All you need to do now is re-enable color and depth writing if you had disabled those earlier and setting the test function to determine which fragments are drawn based on the values in the stencil buffer.</p>

<pre><code class="cpp">glStencilFunc(GL_EQUAL, <span class="number">1</span>, <span class="number">0xFF</span>);
</code></pre>

<p>If you use this call to set the test function, the stencil test will only pass for pixels with a stencil value equal to 1. A fragment will only be drawn if it passes both the stencil and depth test, so setting the <a href="http://docs.gl/gl3/glStencilOp"><code>glStencilOp</code></a> is not necessary. In the case of the example above only the stencil values in the rectangular area were set to 1, so only the cube fragments in that area will be drawn.</p>

<pre><code class="cpp">glStencilMask(<span class="number">0x00</span>);
</code></pre>

<p>One small detail that is easy to overlook is that the cube draw call could still affect values in the stencil buffer. This problem can be solved by setting the stencil bit mask to all zeroes, which effectively disables stencil writing.</p>

<h1 id="Planarreflections">Planar reflections</h1>

<p>Let's spice up the demo we have right now a bit by adding a floor with a reflection under the cube. I'll add the vertices for the floor to the same vertex buffer the cube is currently using to keep things simple:</p>

<pre><code class="cpp"><span class="keyword">float</span> vertices[] = {
    ...

    -<span class="number">1.0</span>f, -<span class="number">1.0</span>f, -<span class="number">0.5</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f,
     <span class="number">1.0</span>f, -<span class="number">1.0</span>f, -<span class="number">0.5</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">1.0</span>f, <span class="number">0.0</span>f,
     <span class="number">1.0</span>f,  <span class="number">1.0</span>f, -<span class="number">0.5</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">1.0</span>f, <span class="number">1.0</span>f,
     <span class="number">1.0</span>f,  <span class="number">1.0</span>f, -<span class="number">0.5</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">1.0</span>f, <span class="number">1.0</span>f,
    -<span class="number">1.0</span>f,  <span class="number">1.0</span>f, -<span class="number">0.5</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">1.0</span>f,
    -<span class="number">1.0</span>f, -<span class="number">1.0</span>f, -<span class="number">0.5</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f
}
</code></pre>

<p>Now add the extra draw call to your main loop:</p>

<pre><code class="cpp">glDrawArrays(GL_TRIANGLES, <span class="number">36</span>, <span class="number">6</span>);
</code></pre>

<p>To create the reflection of the cube itself, it is sufficient to draw it again but inverted on the Z-axis:</p>

<pre><code class="cpp">model = glm::scale(
    glm::translate(model, glm::vec3(<span class="number">0</span>, <span class="number">0</span>, -<span class="number">1</span>)),
    glm::vec3(<span class="number">1</span>, <span class="number">1</span>, -<span class="number">1</span>)
);
glUniformMatrix4fv(uniModel, <span class="number">1</span>, GL_FALSE, glm::value_ptr(model));
glDrawArrays(GL_TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);
</code></pre>

<p>I've set the color of the floor vertices to black so that the floor does not display the texture image, so you'll want to change the clear color to white to be able to see it. I've also changed the camera parameters a bit to get a good view of the scene.</p>

<div class="livedemo_wrap">
    <div class="livedemo" id="demo_c5_floor" style="background: url(&#39;/media/img/c5_window3.png&#39;)">
        <canvas width="640" height="480"></canvas>
        <script type="text/javascript" src="./OpenGL - Depth and stencils_files/c5_floor.js.download"></script>
    </div>
</div>

<p>Two issues are noticeable in the rendered image:</p>

<ul>
<li>The floor occludes the reflection because of depth testing.</li>
<li>The reflection is visible outside of the floor.</li>
</ul>

<p>The first problem is easy to solve by temporarily disabling writing to the depth buffer when drawing the floor:</p>

<pre><code class="cpp">glDepthMask(GL_FALSE);
glDrawArrays(GL_TRIANGLES, <span class="number">36</span>, <span class="number">6</span>);
glDepthMask(GL_TRUE);
</code></pre>

<p>To fix the second problem, it is necessary to discard fragments that fall outside of the floor. Sounds like it's time to see what stencil testing is really worth!</p>

<p>It can be greatly beneficial at times like these to make a little list of the rendering stages of the scene to get a proper idea of what is going on.</p>

<ul>
<li>Draw regular cube.</li>
<li>Enable stencil testing and set test function and operations to write ones to all selected stencils.</li>
<li>Draw floor.</li>
<li>Set stencil function to pass if stencil value equals 1.</li>
<li>Draw inverted cube.</li>
<li>Disable stencil testing.</li>
</ul>

<p>The new drawing code looks like this:</p>

<pre><code class="cpp">glEnable(GL_STENCIL_TEST);

    <span class="comment">// Draw floor</span>
    glStencilFunc(GL_ALWAYS, <span class="number">1</span>, <span class="number">0xFF</span>); <span class="comment">// Set any stencil to 1</span>
    glStencilOp(GL_KEEP, GL_KEEP, GL_REPLACE);
    glStencilMask(<span class="number">0xFF</span>); <span class="comment">// Write to stencil buffer</span>
    glDepthMask(GL_FALSE); <span class="comment">// Don't write to depth buffer</span>
    glClear(GL_STENCIL_BUFFER_BIT); <span class="comment">// Clear stencil buffer (0 by default)</span>

    glDrawArrays(GL_TRIANGLES, <span class="number">36</span>, <span class="number">6</span>);

    <span class="comment">// Draw cube reflection</span>
    glStencilFunc(GL_EQUAL, <span class="number">1</span>, <span class="number">0xFF</span>); <span class="comment">// Pass test if stencil value is 1</span>
    glStencilMask(<span class="number">0x00</span>); <span class="comment">// Don't write anything to stencil buffer</span>
    glDepthMask(GL_TRUE); <span class="comment">// Write to depth buffer</span>

    model = glm::scale(
        glm::translate(model, glm::vec3(<span class="number">0</span>, <span class="number">0</span>, -<span class="number">1</span>)),
        glm::vec3(<span class="number">1</span>, <span class="number">1</span>, -<span class="number">1</span>)
    );
    glUniformMatrix4fv(uniModel, <span class="number">1</span>, GL_FALSE, glm::value_ptr(model));
    glDrawArrays(GL_TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);

glDisable(GL_STENCIL_TEST);
</code></pre>

<p>I've annotated the code above with comments, but the steps should be mostly clear from the stencil buffer section.</p>

<p>Now just one final touch is required, to darken the reflected cube a little to make the floor look a little less like a perfect mirror. I've chosen to create a uniform for this called <code>overrideColor</code> in the vertex shader:</p>

<pre><code class="cpp">uniform vec3 overrideColor;
...
Color = overrideColor * color;
</code></pre>

<p>And in the drawing code for the reflected cube</p>

<pre><code class="cpp">glUniform3f(uniColor, <span class="number">0.3</span>f, <span class="number">0.3</span>f, <span class="number">0.3</span>f);
    glDrawArrays(GL_TRIANGLES, <span class="number">0</span>, <span class="number">36</span>);
glUniform3f(uniColor, <span class="number">1.0</span>f, <span class="number">1.0</span>f, <span class="number">1.0</span>f);
</code></pre>

<p>where <code>uniColor</code> is the return value of a <a href="http://docs.gl/gl3/glGetUniformLocation"><code>glGetUniformLocation</code></a> call.</p>

<div class="livedemo_wrap">
    <div class="livedemo" id="demo_c5_reflection" style="background: url(&#39;/media/img/c5_window4.png&#39;)">
        <canvas width="640" height="480"></canvas>
        <script type="text/javascript" src="./OpenGL - Depth and stencils_files/c5_reflection.js.download"></script>
    </div>
</div>

<p>Awesome! I hope that, especially in chapters like these, you get the idea that working with an API as low-level as OpenGL can be a lot of fun and pose interesting challenges! As usual, the final code is available <a href="https://open.gl/content/code/c5_reflection.txt">here</a>.</p>

<h1 id="Exercises">Exercises</h1>

<p>There are no real exercises for this chapter, but there are a lot more interesting effects you can create with the stencil buffer. I'll leave researching the implementation of other effects, such as <a href="http://en.wikipedia.org/wiki/Shadow_volume#Stencil_buffer_implementations">stencil shadows</a> and <a href="http://www.flipcode.com/archives/Object_Outlining.shtml">object outlining</a> as an exercise to you.</p>
				</article>

                <div id="adbox-article">
                    <hr>

                    <script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                    <!-- Open.GL Responsive -->
                    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4259747131061893" data-ad-slot="6609097747" data-ad-format="auto"></ins>
                    <script>
                        (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>

				
				<!-- Disqus comments -->
				<hr>
				<aside id="disqus_thread"><iframe id="dsq-app1" name="dsq-app1" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="./OpenGL - Depth and stencils_files/saved_resource.html" style="width: 1px !important; min-width: 100% !important; border: none !important; overflow: hidden !important; height: 7544px !important;" horizontalscrolling="no" verticalscrolling="no"></iframe><iframe id="indicator-north" name="indicator-north" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" style="width: 800px !important; border: none !important; overflow: hidden !important; top: 0px !important; min-width: 800px !important; max-width: 800px !important; position: fixed !important; z-index: 2147483646 !important; height: 29px !important; min-height: 29px !important; max-height: 29px !important; display: none !important;" src="./OpenGL - Depth and stencils_files/saved_resource(1).html"></iframe><iframe id="indicator-south" name="indicator-south" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" style="width: 800px !important; border: none !important; overflow: hidden !important; bottom: 0px !important; min-width: 800px !important; max-width: 800px !important; position: fixed !important; z-index: 2147483646 !important; height: 29px !important; min-height: 29px !important; max-height: 29px !important; display: none !important;" src="./OpenGL - Depth and stencils_files/saved_resource(2).html"></iframe></aside>
				<script type="text/javascript">
					var dsq = document.createElement("script");
					dsq.type = "text/javascript";
					dsq.async = true;
					dsq.src = "//opengl.disqus.com/embed.js";
					document.getElementsByTagName("head")[0].appendChild( dsq );
				</script>
							</main>
		</div>
	

<iframe style="display: none;" src="./OpenGL - Depth and stencils_files/saved_resource(3).html"></iframe></body></html>